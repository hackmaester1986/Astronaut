<div class="container">
  <div class="header">
    <h1>Astronaut Duties</h1>
    <div class="picker">
      <label for="astronautSelect">Select person</label>
      <select id="astronautSelect" [(ngModel)]="selectedName" (change)="onSelectName()">
        <option [ngValue]="''" disabled>Select…</option>
        @for(p of people;track p){
          <option [ngValue]="p.name">{{ p.name }}</option>
        }
      </select>
    </div>
  </div>
  @if(loading){
    <div class="state">Loading…</div>
  }
  @if(error){
    <div class="state error">{{ error }}</div>
  }
  @if(person && detail && !loading){
    <div class="profile-card">
      <div class="profile-top">
        <h2 class="name">
          {{ person.name }}
          @if(detail?.currentRank){
            <span class="badge">{{ detail?.currentRank }}</span>
            <button class="edit-btn" aria-label="Edit" (click)="openModalRank()">
              <i class="bi bi-pencil"></i>
            </button>
          }
        </h2>
        @if(detail?.currentDutyTitle){
          <div class="subtitle">{{ detail?.currentDutyTitle }}</div>
        }
      </div>
      <div class="meta">
        @if(person){
          <div><span>Career start:</span> {{ detail?.careerStartDate | date:'mediumDate' }}</div>
          @if(detail.currentDutyTitle.toLowerCase() == 'retired'){
            <div><span>Career end:</span> {{ detail?.careerEndDate | date:'mediumDate' }}</div>
          }
        }
      </div>
    </div>
  }
  @if(person && detail && !loading){
    <div class="table-wrap">
      @if(duties?.length){
        <table class="duty-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Duty Title</th>
              <th>Start Date</th>
              <th>End Date</th>
            </tr>
          </thead>
          <tbody>
            @for(d of duties; track d){
              <tr>
                <td>{{ d.rank }}</td>
                <td>{{ d.dutyTitle }}</td>
                <td>{{ d.dutyStartDate | date:'mediumDate' }}</td>
                <td>
                  @if(d.dutyEndDate) {
                    <span > {{ d.dutyEndDate | date:'mediumDate' }} </span>
                  } 
                  @else {
                    <span class="chip chip-current">Current</span>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      } 
      @else {
        <div class="state">No duties found for {{ person?.name }}.</div>
      }
      @if(detail.currentDutyTitle.toLowerCase() != 'retired'){
          <div class="add-duty-container">
            <button class="add-duty-btn" (click)="openModal()">Add Duty</button>
          </div>
        }
    </div>
  }
  @if(person && !detail && !loading){
    <div class="state">No Astronaut Job found for {{ person?.name }}.</div>
    <div class="add-duty-container">
      <button class="add-duty-btn" (click)="openModalJob()">Create Job</button>
    </div>
  }
  <app-add-duty 
    [duties]="duties"
    (refresh)="setDuties($event)" 
    [person]="person" 
    (close)="showModal = false" 
    [showModal]="showModal">
  </app-add-duty>
  <app-update-rank 
    (refresh)="setRank($event)" 
    [detail]="detail"
    [person]="person" 
    (close)="showModalRank = false" 
    [showModal]="showModalRank">
  </app-update-rank>
  <app-astronaut-job 
    (refresh)="setDetail()" 
    [person]="person" 
    (close)="showModalJob = false" 
    [showModal]="showModalJob">
  </app-astronaut-job>
</div>

